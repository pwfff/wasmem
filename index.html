<html>
    <head>
        <meta charset="utf-8">
        <script src="wasm_exec.js"></script>
        <script>
            const go = new Go();
            let mod, inst;

            let openFile = function(event) {
                var input = event.target;

                var reader = new FileReader();
                reader.onload = function(){
                    let bytes = new Uint8Array(reader.result);
                    let pointer = initMem(bytes.length);

                    let memoryBytes = new Uint8Array(inst.exports.mem.buffer);
                    memoryBytes.set(bytes, pointer);

                    let result = processImage();
                    // arena could have moved
                    memoryBytes = new Uint8Array(inst.exports.mem.buffer);

                    let resultBytes = memoryBytes.slice(result[0], result[0] + result[1]);
                    let blob = new Blob([resultBytes], {'type': 'image/jpeg'});
                    document.getElementById('out').src = URL.createObjectURL(blob);
                };
                reader.readAsArrayBuffer(input.files[0]);
            };

            WebAssembly.instantiateStreaming(
                fetch("main.wasm"),
                go.importObject
            ).then(async (result) => {
                mod = result.module;
                inst = result.instance;
                go.run(inst)
            });
        </script>
    </head>
    <body>
        <input type='file' accept='image/*' onchange='openFile(event)'><br>
        <img id="out" />
    </body>
</html>
